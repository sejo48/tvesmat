<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JORGEDEZ TV App (v5 - URL Remota)</title> <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Completo (Estilo JORGEDEZ + Logos + Mejoras) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scrollbars */
        }

        body {
            background-color: #121212; /* Dark background */
            color: #e0e0e0; /* Light text */
            font-family: 'Roboto', sans-serif;
            display: flex; /* Use flexbox for layout */
        }

        /* Styles for when the app is in fullscreen mode */
        body.fullscreen-active .sidebar {
            width: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
            border: none !important;
            opacity: 0 !important;
        }
        body.fullscreen-active .main-content {
            padding: 0; /* Remove padding in fullscreen */
        }
        body.fullscreen-active #player-placeholder {
            display: none; /* Hide placeholder in fullscreen */
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px; /* Fixed width */
            flex-shrink: 0; /* Prevent sidebar from shrinking */
            background-color: #1C1C1C; /* Slightly lighter dark shade */
            padding: 15px 5px 15px 15px; /* Padding */
            height: 100%;
            overflow-x: hidden; /* Hide horizontal scroll */
            overflow-y: auto; /* Allow vertical scroll if needed */
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            transition: width 0.3s ease-out, padding 0.3s ease-out, opacity 0.3s ease-out; /* Smooth transitions */
            border-right: 1px solid #333; /* Separator line */
            opacity: 1;
        }
        /* Styles for hidden sidebar */
        .sidebar.hidden {
            width: 0;
            padding: 0;
            overflow: hidden;
            border: none;
            opacity: 0;
        }

        /* App Logo Styles */
        #app-logo {
            display: block;
            max-width: 80%;
            height: auto;
            margin: 10px auto 25px auto; /* Center logo */
            flex-shrink: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar.hidden #app-logo {
            opacity: 0; /* Hide logo when sidebar is hidden */
        }

        /* Channel List Styles */
        #channel-list {
            list-style: none; /* Remove bullet points */
            flex-grow: 1; /* Allow list to take available space */
            overflow-y: auto; /* Enable scrolling for the list */
            padding-right: 10px; /* Space for scrollbar */
        }
        /* Custom Scrollbar Styles (Webkit browsers) */
        #channel-list::-webkit-scrollbar {
            width: 8px;
        }
        #channel-list::-webkit-scrollbar-track {
            background: #333;
            border-radius: 4px;
        }
        #channel-list::-webkit-scrollbar-thumb {
            background-color: #666;
            border-radius: 4px;
        }

        /* Channel List Item Styles */
        .channel-list-item {
            padding: 8px 10px; /* Padding around text/logo */
            margin-bottom: 5px; /* Space between items */
            border-radius: 5px; /* Rounded corners */
            cursor: pointer; /* Indicate clickable */
            transition: background-color 0.15s ease, color 0.15s ease, transform 0.15s ease; /* Smooth transitions */
            display: flex; /* Use flex for alignment */
            align-items: center; /* Vertically align items */
            font-size: 0.95em; /* Slightly smaller text */
            color: #b3b3b3; /* Default text color */
            white-space: nowrap; /* Prevent text wrapping */
           }
        .channel-list-item:hover {
            background-color: #282828; /* Darker background on hover */
            color: #ffffff; /* White text on hover */
        }

        /* Channel Logo Styles within the list */
        .channel-list-logo {
            height: 22px; /* Fixed height */
            width: auto; /* Auto width based on aspect ratio */
            max-width: 40px; /* Max width */
            margin-right: 8px; /* Space between logo and icon/text */
            vertical-align: middle; /* Align with text */
            object-fit: contain; /* Prevent image distortion */
            background-color: rgba(255, 255, 255, 0.05); /* Subtle background */
            flex-shrink: 0; /* Prevent logo from shrinking */
            display: inline-block; /* Ensure it displays */
           }
           /* Style for when logo fails to load (handled by JS onerror) */
           img.channel-list-logo[style*="display: none"] {
             /* Can add width:0; margin:0; if needed, but display:none usually suffices */
           }

        /* Icon (Favorite/Play) Styles */
        .channel-list-item .icon {
            margin-right: 8px; /* Space between icon and title */
            font-size: 1.1em;
            flex-shrink: 0;
            width: 1.2em; /* Fixed width for alignment */
            text-align: center;
        }
        .channel-list-item .icon.favorite {
            color: #FFEB3B; /* Yellow for favorite */
        }
        /* Channel Title Styles */
        .channel-list-item .title {
            overflow: hidden; /* Hide overflowing text */
            text-overflow: ellipsis; /* Add '...' for overflow */
            font-weight: 400;
            flex-grow: 1; /* Allow title to take remaining space */
        }

        /* Focused Channel Item Styles (for keyboard navigation) */
        .channel-list-item.focused {
            background-color: #FF0000; /* Red background for focus */
            color: #ffffff; /* White text */
            font-weight: 500; /* Slightly bolder */
            transform: scale(1.02); /* Slight zoom effect */
        }

        /* Main Content Area Styles */
        .main-content {
            flex-grow: 1; /* Take remaining width */
            background-color: #000; /* Black background for player area */
            padding: 0; /* No padding initially */
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
            position: relative; /* For absolute positioning of children */
        }
        /* Channel Details/Status Panel Styles */
        #channel-details {
            display: none; /* Hidden by default */
            position: absolute;
            bottom: 60px; /* Position near the bottom */
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7); /* Semi-transparent background */
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            z-index: 20; /* Ensure it's above the video */
            font-size: 0.9em;
            text-align: center;
        }
        #player-status {
            display: block;
        }

        /* Video Container Styles */
        #video-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000; /* Black background */
            overflow: hidden; /* Hide anything outside */
            position: relative; /* For positioning placeholder/loader */
        }
        /* Player Placeholder Styles (shown when no video is loaded) */
        #player-placeholder {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #111; /* Slightly lighter black */
            z-index: 5; /* Below video, above background */
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        #player-placeholder.hidden {
            opacity: 0;
            pointer-events: none; /* Prevent interaction when hidden */
        }
        #player-placeholder img {
            max-width: 180px;
            max-height: 150px;
            margin-bottom: 20px;
            opacity: 0.7;
        }
        #player-placeholder p {
            color: #888; /* Grey text */
            font-size: 1.1em;
        }

        /* Loading Spinner Styles */
        .loader {
            border: 5px solid #444; /* Grey border */
            border-top: 5px solid #FF0000; /* Red spinning part */
            border-radius: 50%; /* Make it round */
            width: 40px; height: 40px;
            animation: spin 1s linear infinite; /* Spin animation */
            position: absolute; /* Position in the center of video-container */
            top: calc(50% - 20px);
            left: calc(50% - 20px);
            z-index: 15; /* Above placeholder, below status panel */
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Video Player Element Styles */
        #video-player {
            display: none; /* Hidden until a stream is loaded */
            width: 100%;
            height: 100%;
            background-color: #000; /* Black background */
            position: relative;
            z-index: 10; /* Above placeholder/loader */
        }
        /* Ensure video fills container in fullscreen */
        #video-container:-webkit-full-screen,
        #video-container:fullscreen {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <img id="app-logo" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgVIFxWI-sdOR2bVfpbgCotXquColWskv4u4I9HXZhYdsRewDVRNcJ7iLvtKO2xYucvqOv0DKY2MArMnHGF8IvZBI7NYjg0dkjHUN0N8VXwZ73vKjYOajWC6JTze5n1Hcj19V2COVFkN-TtJA7uR_ALIYyIcvUBOwQN1EmURskiBCI_lJK3hFphdSBuCaQ/w547-h320/logo%20(%20JORGEDEZ%20)%20ROJO%20Y%20BLANCO%20PARA%20VIDEO.jpeg" alt="JORGEDEZ Logo">
            <ul id="channel-list"></ul>
        </div>
        <div class="main-content">
            <div id="channel-details"><p id="player-status"></p></div>
            <div id="video-container">
                 <div id="player-placeholder">
                     <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgVIFxWI-sdOR2bVfpbgCotXquColWskv4u4I9HXZhYdsRewDVRNcJ7iLvtKO2xYucvqOv0DKY2MArMnHGF8IvZBI7NYjg0dkjHUN0N8VXwZ73vKjYOajWC6JTze5n1Hcj19V2COVFkN-TtJA7uR_ALIYyIcvUBOwQN1EmURskiBCI_lJK3hFphdSBuCaQ/w547-h320/logo%20(%20JORGEDEZ%20)%20ROJO%20Y%20BLANCO%20PARA%20VIDEO.jpeg" alt="JORGEDEZ">
                     <p>Selecciona un canal</p>
                 </div>
                 <div class="loader"></div>
                 <video id="video-player" controls autoplay playsinline>Video no soportado.</video>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        // --- JavaScript con carga de M3U desde URL ---
        document.addEventListener('DOMContentLoaded', async () => { // Mark as async for await fetch

            // --- URL apunta a la lista M3U REMOTA ---
            // --- Changed from local 'tv.m3u' to the GitHub URL ---
            const m3uUrl = 'https://raw.githubusercontent.com/sejo48/retrom3u/refs/heads/main/listaoficial.m3u';

            // Get references to DOM elements
            const channelListElement = document.getElementById('channel-list');
            const sidebarElement = document.querySelector('.sidebar');
            const videoPlayer = document.getElementById('video-player');
            const videoContainer = document.getElementById('video-container');
            const playerStatus = document.getElementById('player-status');
            const detailsPanel = document.getElementById('channel-details');
            const loaderElement = document.querySelector('.loader');
            const placeholderElement = document.getElementById('player-placeholder');

            // State variables
            let channels = []; // Will be filled from the M3U URL
            let currentFocusIndex = 0; // Index of the currently focused channel in the list
            let hls = null; // HLS.js instance
            let currentStreamUrl = null; // URL of the currently playing stream
            let sidebarHideTimeout = null; // Timeout ID for auto-hiding the sidebar
            const SIDEBAR_TIMEOUT_DURATION = 4000; // 4 seconds
            let favorites = loadFavorites(); // Load favorite channels from localStorage
            let lastChannelUrl = localStorage.getItem('jorgedezLastChannel'); // Load last played channel URL

            // --- Function to parse the M3U content ---
            function parseM3U(data) {
                const lines = data.split('\n'); // Split text into lines
                const parsedChannels = []; // Array to hold parsed channel objects
                let currentChannel = null; // Temporary object for the channel being parsed

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim(); // Get current line and remove whitespace

                    // Check if the line contains channel information (#EXTINF)
                    if (line.startsWith('#EXTINF:')) {
                        // Extract title (text after the last comma)
                        let title = line.substring(line.lastIndexOf(',') + 1);
                        let logo = ''; // Initialize logo URL
                        // Extract logo URL using regex (tvg-logo="...")
                        const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                        if (logoMatch && logoMatch[1]) {
                            logo = logoMatch[1];
                        }
                        // Create a new channel object (URL will be added from the next line)
                        currentChannel = { title: title || 'Canal sin título', logo: logo, url: '' };

                    // Check if it's a stream URL line (not empty, not a comment '#', and follows an #EXTINF line)
                    } else if (line && !line.startsWith('#') && currentChannel) {
                        // Basic check if the line looks like a stream URL
                        if (line.toLowerCase().includes('.m3u8') || line.toLowerCase().startsWith('http')) {
                            currentChannel.url = line; // Assign the URL to the current channel object
                            parsedChannels.push(currentChannel); // Add the completed channel object to the list
                        } else {
                            // Log lines that are ignored (don't seem like valid stream URLs)
                            console.log(`Línea ignorada (no parece URL de stream válida): ${line}`);
                        }
                        // Reset currentChannel, waiting for the next #EXTINF
                        currentChannel = null;
                    }
                }
                console.log(`M3U Parseado: ${parsedChannels.length} canales encontrados.`);
                return parsedChannels; // Return the list of channel objects
            }

            // --- Favorite Functions (localStorage) ---
            function loadFavorites() {
                const f = localStorage.getItem('jorgedezFavorites'); // Get favorites string
                return f ? JSON.parse(f) : []; // Parse JSON or return empty array
            }
            function saveFavorites(f) {
                localStorage.setItem('jorgedezFavorites', JSON.stringify(f)); // Save favorites array as JSON string
            }
            function isChannelFavorite(url) {
                return url ? favorites.includes(url) : false; // Check if URL is in the favorites array
            }
            function toggleChannelFavorite(url) {
                if(!url) return; // Do nothing if URL is invalid
                const index = favorites.indexOf(url); // Find index of URL in favorites
                if (index > -1) { // If found (already favorite)
                    favorites.splice(index, 1); // Remove it
                    console.log("Quitado Fav:", url);
                } else { // If not found (not favorite)
                    favorites.push(url); // Add it
                    console.log("Añadido Fav:", url);
                }
                saveFavorites(favorites); // Save the updated list
                renderChannels(); // Re-render the channel list to reflect changes
            }

            // --- Sidebar Functions ---
            function hideSidebar() {
                // Hide sidebar only if not in fullscreen mode
                if (!document.body.classList.contains('fullscreen-active')) {
                    sidebarElement.classList.add('hidden');
                }
            }
            function showSidebarAndResetTimeout() {
                clearTimeout(sidebarHideTimeout); // Clear any existing hide timeout
                sidebarElement.classList.remove('hidden'); // Show the sidebar
                // Set a new timeout to hide the sidebar after a delay
                sidebarHideTimeout = setTimeout(hideSidebar, SIDEBAR_TIMEOUT_DURATION);
            }

            // --- Core Functions (Render Channels, Update Focus) ---
            function renderChannels() {
                console.log("Renderizando canales...");
                channelListElement.innerHTML = ''; // Clear the current list

                // Handle case where no channels were loaded
                if (!channels || channels.length === 0) {
                    console.warn("Lista de canales vacía después de intentar cargar M3U.");
                    channelListElement.innerHTML = '<li style="color: #aaa; padding: 10px;">No se cargaron canales. Revisa la URL del M3U o la conexión.</li>';
                    return;
                }

                // Mark channels as favorite
                channels.forEach(c => { c.isFavorite = isChannelFavorite(c.url); });
                // Sort channels: favorites first, then alphabetically by title
                channels.sort((a, b) => (b.isFavorite - a.isFavorite) || (a.title ? a.title.localeCompare(b.title || '') : -1));

                // Create and append list items for each channel
                channels.forEach((channel) => {
                    const item = document.createElement('li');
                    item.classList.add('channel-list-item');
                    // Store channel data in dataset attributes for easy access
                    item.dataset.url = channel.url;
                    item.dataset.title = channel.title;
                    item.dataset.logo = channel.logo;
                    item.dataset.isFavorite = channel.isFavorite;
                    item.setAttribute('tabindex', -1); // Make focusable programmatically

                    // Create logo image element
                    const logoImg = document.createElement('img');
                    logoImg.classList.add('channel-list-logo');
                    logoImg.src = channel.logo || ''; // Set src, empty if no logo
                    logoImg.alt = ""; // Alt text not needed for decorative logos
                    logoImg.loading = 'lazy'; // Lazy load images
                    // Hide image element if it fails to load
                    logoImg.onerror = function() { this.style.display = 'none'; };

                    // Create icon span (Favorite or Play)
                    const iconSpan = document.createElement('span');
                    iconSpan.classList.add('icon');
                    iconSpan.textContent = channel.isFavorite ? '★' : '►'; // Star or Play symbol
                    if (channel.isFavorite) iconSpan.classList.add('favorite'); // Add class for styling

                    // Create title span
                    const titleSpan = document.createElement('span');
                    titleSpan.classList.add('title');
                    titleSpan.textContent = channel.title || "Canal sin nombre"; // Display title

                    // Append elements to the list item
                    item.appendChild(logoImg);
                    item.appendChild(iconSpan);
                    item.appendChild(titleSpan);
                    // Append list item to the channel list
                    channelListElement.appendChild(item);
                });
                console.log("Canales renderizados:", channels.length);

                // --- Restore Focus ---
                // Determine which URL to focus initially (last played or first in the list)
                const urlToFocus = lastChannelUrl || (channels.length > 0 ? channels[0].url : null);
                let newFocusIndex = 0; // Default to first item
                if (urlToFocus) {
                    // Find the index of the item matching the URL to focus
                    const itemsNow = channelListElement.querySelectorAll('.channel-list-item');
                    itemsNow.forEach((item, index) => {
                        if (item.dataset.url === urlToFocus) {
                            newFocusIndex = index;
                        }
                    });
                }
                // Ensure the calculated index is within bounds
                const itemsTotal = channelListElement.querySelectorAll('.channel-list-item').length;
                if (newFocusIndex >= itemsTotal) {
                    newFocusIndex = Math.max(0, itemsTotal - 1);
                }
                updateFocus(newFocusIndex); // Apply the focus
            }

            function updateFocus(newIndex) {
                const items = channelListElement.querySelectorAll('.channel-list-item');
                // Validate new index
                if (newIndex < 0 || newIndex >= items.length || items.length === 0) return;

                // Remove focus from the old item
                const oldFocused = channelListElement.querySelector('.channel-list-item.focused');
                if(oldFocused) oldFocused.classList.remove('focused');

                // Set new focus index and get the corresponding item
                currentFocusIndex = newIndex;
                const currentItem = items[currentFocusIndex];
                if (!currentItem) return; // Should not happen, but safety check

                // Apply focus style and programmatically focus the element
                currentItem.classList.add('focused');
                currentItem.focus(); // Important for keyboard navigation

                // --- Scroll sidebar to keep focused item visible ---
                const itemTop = currentItem.offsetTop - sidebarElement.offsetTop; // Item position relative to sidebar top
                const itemHeight = currentItem.offsetHeight;
                const sidebarScrollTop = sidebarElement.scrollTop; // Current scroll position
                const sidebarHeight = sidebarElement.clientHeight; // Visible height

                if (itemTop < sidebarScrollTop) { // If item is above visible area
                    sidebarElement.scrollTop = itemTop - 10; // Scroll up
                } else if (itemTop + itemHeight > sidebarScrollTop + sidebarHeight) { // If item is below visible area
                    sidebarElement.scrollTop = itemTop + itemHeight - sidebarHeight + 10; // Scroll down
                }
            }

            // --- Player and Controls Functions ---
            function setPlayerStatus(message, isError = false) {
                console.log("Set Status:", message, "Error:", isError);
                // Reset UI elements
                loaderElement.style.display = 'none';
                videoPlayer.style.display = 'none';
                placeholderElement.classList.add('hidden'); // Hide placeholder initially
                if(detailsPanel) detailsPanel.style.display = 'none'; // Hide details panel

                if (message === "Cargando...") { // Show loader if loading
                    loaderElement.style.display = 'block';
                } else if (message) { // Show status message if provided
                    if (detailsPanel) {
                        playerStatus.textContent = message;
                        detailsPanel.style.display = 'block'; // Show the panel
                        playerStatus.style.color = isError ? '#ff8a80' : '#ffcc80'; // Red for error, orange for info
                    }
                } else if (currentStreamUrl) { // If no message and a stream is supposed to be playing
                    videoPlayer.style.display = 'block'; // Show the video player
                } else { // If no message and no stream, show the placeholder
                    placeholderElement.classList.remove('hidden');
                }
            }

            function playStream(url) {
                if (!url) { // Check for invalid URL
                    setPlayerStatus("URL no válida.", true);
                    return;
                }
                // If the same stream is already loaded and playing, just ensure it's visible and playing
                if (url === currentStreamUrl && videoPlayer.style.display === 'block') {
                    setPlayerStatus(""); // Clear any status message
                    videoPlayer.play().catch(e=>console.warn("Autoplay maybe blocked:", e)); // Try to play (might be blocked by browser)
                    return;
                }

                console.log("Intentando cargar:", url);
                setPlayerStatus("Cargando..."); // Show loading indicator
                clearTimeout(sidebarHideTimeout); // Stop sidebar from hiding
                hideSidebar(); // Hide sidebar immediately

                // Cleanup previous HLS instance if exists
                if (hls) {
                    hls.destroy();
                    hls = null;
                }
                // Reset video player
                videoPlayer.pause();
                videoPlayer.removeAttribute('src'); // Remove src attribute
                videoPlayer.load(); // Reset media element state

                const isM3U8 = url.toLowerCase().includes('.m3u8'); // Check if it's an HLS stream

                // --- Playback Logic ---

                // 1. Use HLS.js if supported and it's an M3U8 stream
                if (isM3U8 && Hls.isSupported()) {
                    console.log("Usando HLS.js para:", url);
                    hls = new Hls({}); // Create HLS.js instance
                    hls.loadSource(url); // Load the stream URL
                    hls.attachMedia(videoPlayer); // Attach to the video element

                    // Event listener for when the manifest is parsed
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        setPlayerStatus(""); // Clear loading status
                        videoPlayer.muted = false; // Try playing with sound first
                        videoPlayer.play().catch(e => {
                            // --- Autoplay Handling ---
                            // If play() fails (often due to browser autoplay policy),
                            // show a message asking the user to click play manually.
                            console.error("Error al iniciar play() tras manifest parsed (HLS.js):", e);
                            setPlayerStatus("Click Play si no inicia", false); // Inform user
                        });
                        currentStreamUrl = url; // Store the current URL
                        localStorage.setItem('jorgedezLastChannel', url); // Save as last played channel
                    });

                    // Event listener for HLS errors
                    hls.on(Hls.Events.ERROR, (event, data) => {
                        console.error('HLS Error:', data);
                        let msg = `Error HLS: ${data.details}`;
                        // Provide more specific error messages
                        if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                            if (data.details === Hls.ErrorDetails.MANIFEST_LOAD_ERROR) msg = "Error Red: No se pudo cargar la lista.";
                            else if (data.details === Hls.ErrorDetails.MANIFEST_LOAD_TIMEOUT) msg = "Error Red: Tiempo de espera agotado.";
                        } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                            msg = `Error Media: (${data.details})`;
                        }
                        setPlayerStatus(msg, true); // Show error status
                        currentStreamUrl = null; // Reset current stream URL
                    });

                // 2. Use Native HLS support if available (e.g., Safari) and it's M3U8
                } else if (isM3U8 && videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    console.log("Usando soporte HLS nativo para:", url);

                    const playHandler = () => {
                        setPlayerStatus("");
                        videoPlayer.muted = false;
                        videoPlayer.play().catch(e => {
                            // --- Autoplay Handling (Native) ---
                            console.error("Error al iniciar play() nativo HLS:", e);
                            setPlayerStatus("Click Play.", false);
                        });
                        currentStreamUrl = url;
                        localStorage.setItem('jorgedezLastChannel', url);
                        removeNativeListeners(); // Clean up listeners
                    };
                    const errorHandler = (e) => {
                        console.error("Error HLS Nativo:", e);
                        setPlayerStatus("Error nativo HLS.", true);
                        currentStreamUrl = null;
                        removeNativeListeners(); // Clean up listeners
                    };
                    const removeNativeListeners = () => {
                        videoPlayer.removeEventListener('loadeddata', playHandler);
                        videoPlayer.removeEventListener('error', errorHandler);
                    };

                    // Add temporary event listeners
                    videoPlayer.addEventListener('loadeddata', playHandler, { once: true });
                    videoPlayer.addEventListener('error', errorHandler, { once: true });
                    videoPlayer.src = url; // Set the src directly

                // 3. Try direct playback for non-M3U8 URLs (e.g., MP4, WebM - might not work for live streams)
                } else if (!isM3U8 && (url.toLowerCase().startsWith('http') || url.includes(':'))) {
                    console.log("Intentando reproducción directa (no M3U8) para:", url);

                     const playDirectHandler = () => {
                         setPlayerStatus("");
                         videoPlayer.muted = false;
                         videoPlayer.play().catch(e => {
                             // --- Autoplay Handling (Direct) ---
                             console.error("Error al iniciar play() directo:", e);
                             setPlayerStatus("Click Play si no inicia", false);
                         });
                         currentStreamUrl = url;
                         localStorage.setItem('jorgedezLastChannel', url);
                         removeDirectListeners(); // Clean up listeners
                     };
                     const errorDirectHandler = (e) => {
                         console.error("Error directo:", e);
                         // Common error for unsupported formats or network issues
                         setPlayerStatus("Error: formato no soportado o URL incorrecta.", true);
                         currentStreamUrl = null;
                         removeDirectListeners(); // Clean up listeners
                     };
                     const removeDirectListeners = () => {
                         videoPlayer.removeEventListener('canplay', playDirectHandler); // Use 'canplay' as trigger
                         videoPlayer.removeEventListener('error', errorDirectHandler);
                     };

                     // Add temporary event listeners
                     videoPlayer.addEventListener('canplay', playDirectHandler, { once: true });
                     videoPlayer.addEventListener('error', errorDirectHandler, { once: true });
                     videoPlayer.src = url; // Set the src directly

                // 4. If none of the above work (unsupported format/URL)
                } else {
                    setPlayerStatus("Navegador no soporta HLS o URL no válida.", true);
                    currentStreamUrl = null;
                }
            }

            function toggleFullScreen() {
                const elementToMakeFullScreen = videoContainer; // Fullscreen the container
                const isInFullScreen = document.fullscreenElement || document.webkitFullscreenElement;
                console.log("Toggle Fullscreen. Is fullscreen?:", !!isInFullScreen);

                if (!isInFullScreen) { // Enter fullscreen
                    if (elementToMakeFullScreen.requestFullscreen) {
                        elementToMakeFullScreen.requestFullscreen().catch(err => console.error("Error entering FS:", err));
                    } else if (elementToMakeFullScreen.webkitRequestFullscreen) { // Safari
                        elementToMakeFullScreen.webkitRequestFullscreen().catch(err => console.error("Error entering webkitFS:", err));
                    } else {
                        console.warn("API Fullscreen no soportada");
                    }
                } else { // Exit fullscreen
                    if (document.exitFullscreen) {
                        document.exitFullscreen().catch(err => console.error("Error exiting FS:", err));
                    } else if (document.webkitExitFullscreen) { // Safari
                        document.webkitExitFullscreen().catch(err => console.error("Error exiting webkitExitFS:", err));
                    } else {
                        console.warn("API exitFullscreen no soportada");
                    }
                }
            }

            // --- Event Handlers ---
            function handleKeyPress(event) {
                const isInFullScreen = !!(document.fullscreenElement || document.webkitFullscreenElement);

                // Allow Escape key to exit fullscreen naturally
                if (event.key === 'Escape' && isInFullScreen) return;

                // Toggle fullscreen with 'f' key
                if (event.key === 'f') {
                    event.preventDefault();
                    toggleFullScreen();
                    return;
                }

                // Ignore other keys if in fullscreen
                if (isInFullScreen) return;

                const items = channelListElement.querySelectorAll('.channel-list-item');
                if (items.length === 0) return; // No channels to navigate

                // Map keys to actions (including common remote codes)
                const keyMap = {
                    'ArrowUp': 'up',
                    'ArrowDown': 'down',
                    'Enter': 'ok',
                    'Accept': 'ok', // Some remote key name
                    'Ok': 'ok',       // Some remote key name
                    '5': 'favorite',  // Number 5 key for favorite
                    '*': 'favorite'   // Star key for favorite
                };
                const action = keyMap[event.key];
                if (!action) return; // Ignore unmapped keys

                event.preventDefault(); // Prevent default browser action (e.g., scrolling)

                // Show sidebar and reset hide timer on navigation/action
                if (['up', 'down', 'ok', 'favorite'].includes(action)) {
                    showSidebarAndResetTimeout();
                }

                let newIndex = currentFocusIndex;
                switch (action) {
                    case 'up':
                        newIndex = currentFocusIndex - 1;
                        if (newIndex < 0) newIndex = items.length - 1; // Wrap around to bottom
                        break;
                    case 'down':
                        newIndex = currentFocusIndex + 1;
                        if (newIndex >= items.length) newIndex = 0; // Wrap around to top
                        break;
                    case 'ok':
                        const selectedItem = items[currentFocusIndex];
                        if (selectedItem) playStream(selectedItem.dataset.url); // Play selected channel
                        return; // Don't update focus, just play
                    case 'favorite':
                        const favItem = items[currentFocusIndex];
                        if (favItem) {
                            toggleChannelFavorite(favItem.dataset.url); // Toggle favorite status
                            // renderChannels() is called inside toggleChannelFavorite, which handles focus update
                        }
                        return; // Don't update focus here
                }

                // Update focus only if the index actually changed
                if (newIndex !== currentFocusIndex) {
                    updateFocus(newIndex);
                }
            }

            function handleFullscreenChange() {
                const isInFullScreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
                // Add/remove class to body for CSS adjustments
                document.body.classList.toggle('fullscreen-active', isInFullScreen);

                if (!isInFullScreen) { // Exiting fullscreen
                    // Re-focus the current channel item in the list
                    const item = channelListElement.querySelectorAll('.channel-list-item')[currentFocusIndex];
                    if(item) item.focus();
                    // Show sidebar and restart auto-hide timer
                    showSidebarAndResetTimeout();
                } else { // Entering fullscreen
                    clearTimeout(sidebarHideTimeout); // Stop sidebar from auto-hiding
                }
            }

            // --- Initialization ---
            async function initializeApp() {
                // Update initial status message
                setPlayerStatus("Cargando lista desde URL...");
                try {
                    console.log("Intentando cargar M3U desde URL:", m3uUrl);
                    // Fetch the M3U file from the URL
                    const response = await fetch(m3uUrl);
                    if (!response.ok) {
                        // Throw an error if the fetch failed (e.g., 404 Not Found, network error)
                        throw new Error(`Error ${response.status} al cargar M3U desde URL. Verifica la URL y la conexión.`);
                    }
                    const m3uData = await response.text(); // Get M3U content as text
                    channels = parseM3U(m3uData); // Parse the text data

                    // Render channels and set up event listeners
                    renderChannels();
                    document.addEventListener('keydown', handleKeyPress);
                    // Handle clicks on channel list items
                    channelListElement.addEventListener('click', (e)=>{
                        const clickedItem = e.target.closest('.channel-list-item');
                        if(!clickedItem) return; // Ignore clicks outside items
                        const urlToPlay = clickedItem.dataset.url;
                        const items = channelListElement.querySelectorAll('.channel-list-item');
                        let indexToFocus = -1;
                        // Find the index of the clicked item to update focus correctly
                        items.forEach((item, idx)=>{
                            if(item.dataset.url === urlToPlay) indexToFocus = idx;
                        });
                        if(urlToPlay && indexToFocus !== -1){
                            updateFocus(indexToFocus); // Focus the clicked item
                            playStream(urlToPlay); // Play the stream
                        }
                    });
                    // Double click on video area to toggle fullscreen
                    videoContainer.addEventListener('dblclick', toggleFullScreen);
                    // Listen for fullscreen changes (browser events)
                    document.addEventListener('fullscreenchange', handleFullscreenChange);
                    document.addEventListener('webkitfullscreenchange', handleFullscreenChange); // Safari prefix

                    showSidebarAndResetTimeout(); // Show sidebar initially
                    setPlayerStatus(null); // Clear loading status

                } catch (error) {
                    // Handle errors during initialization (fetch, parse)
                    console.error("Error al cargar o procesar M3U desde URL:", error);
                    setPlayerStatus(`Error al cargar canales: ${error.message}`, true); // Show error to user
                    // Display error in the channel list area as well
                    channelListElement.innerHTML = `<li style="color: #ff8a80; padding: 10px;">Error cargando lista: ${error.message}.</li>`;
                }
            }

            // Start the application initialization
            initializeApp();

        });
    </script>

</body>
</html>
```


